%% Kleanthis E Karavangelas, Basem Saleh
% Assignment 4, ECES 435

%% Part 1: JPEGsnoop
% 
% imageOrigin1.jpg: 
% Exif
%     [Make] = "Canon"
%     [Model] = "Canon PowerShot A75"


% Luminance Table:
%     DQT, Row #0:   1   1   1   2   3   6   8  10 
%     DQT, Row #1:   1   1   2   3   4   8   9   8 
%     DQT, Row #2:   2   2   2   3   6   8  10   8 
%     DQT, Row #3:   2   2   3   4   7  12  11   9 
%     DQT, Row #4:   3   3   8  11  10  16  15  11 
%     DQT, Row #5:   3   5   8  10  12  15  16  13 
%     DQT, Row #6:   7  10  11  12  15  17  17  14 
%     DQT, Row #7:  14  13  13  15  15  14  14  14 
%     Approx quality factor = 92.96 (scaling=14.08 variance=5.28)
%
% Chrominance Table:
%     DQT, Row #0:   4   4   5   9  15  26  26  26 
%     DQT, Row #1:   4   4   5  10  19  26  26  26 
%     DQT, Row #2:   5   5   8   9  26  26  26  26 
%     DQT, Row #3:   9  10   9  13  26  26  26  26 
%     DQT, Row #4:  15  19  26  26  26  26  26  26 
%     DQT, Row #5:  26  26  26  26  26  26  26  26 
%     DQT, Row #6:  26  26  26  26  26  26  26  26 
%     DQT, Row #7:  26  26  26  26  26  26  26  26 
%     Approx quality factor = 88.24 (scaling=23.52 variance=21.42)
%
% The Exif image data matches the reported camera at the end of the
% JPEGsnoop data.

% imageOrigin2.jpg
% Exif
%     [Make] = "Minolta Co., Ltd."
%     [Model] = "DiMAGE S304"
%
% Luminance Table:
%     DQT, Row #0:   1   1   4   5   6   5   2   5 
%     DQT, Row #1:   1   2   6   5   1   2   8   5 
%     DQT, Row #2:   1   1   2   1   1   8   3   6 
%     DQT, Row #3:   1   1   1   1   6   2   8  12 
%     DQT, Row #4:   1   2   5   1   7  10  10  12 
%     DQT, Row #5:   4   6   2  10  11   8  10  11 
%     DQT, Row #6:   5   3  10   9   7   7   9  10 
%     DQT, Row #7:   5   6   4   6   9   9  10   9 
%     Approx quality factor = 94.65 (scaling=10.71 variance=62.00)

%
%	Chrominance Table:
%     DQT, Row #0:   1   1   9   9   9   9   9   9 
%     DQT, Row #1:   2   9   9   9   2   9   9   9 
%     DQT, Row #2:   4   1   9   2   6   9   9   9 
%     DQT, Row #3:   2   6   5   4   9   9   9   9 
%     DQT, Row #4:   2   9   9   9   9   9   9   9 
%     DQT, Row #5:   9   9   9   9   9   9   9   9 
%     DQT, Row #6:   9   9   9   9   9   9   9   9 
%     DQT, Row #7:   9   9   9   9   9   9   9   9 
%     Approx quality factor = 94.92 (scaling=10.16 variance=47.37)
%
% The Exif image data matches the reported camera at the end of the
% JPEGsnoop data.

% imageOrigin3.jpg

%     [Make] = "Canon"
%     [Model] = "Canon PowerShot SD400"


% Luminance Table
%     DQT, Row #0:   1   1   2   2   3   3   7  14 
%     DQT, Row #1:   1   1   2   2   3   5  10  13 
%     DQT, Row #2:   1   2   2   3   8   8  11  13 
%     DQT, Row #3:   2   3   3   4  11  10  12  15 
%     DQT, Row #4:   3   4   6   7  10  12  15  15 
%     DQT, Row #5:   6   8   8  12  16  15  17  14 
%     DQT, Row #6:   8   9  10  11  15  16  17  14 
%     DQT, Row #7:  10   8   8   9  11  13  14  14 
%     Approx quality factor = 92.73 (scaling=14.53 variance=19.39)

% Chrominance Table
%     Destination ID=1 (Chrominance)
%     DQT, Row #0:   4   4   5   9  15  26  26  26 
%     DQT, Row #1:   4   4   5  10  19  26  26  26 
%     DQT, Row #2:   5   5   8   9  26  26  26  26 
%     DQT, Row #3:   9  10   9  13  26  26  26  26 
%     DQT, Row #4:  15  19  26  26  26  26  26  26 
%     DQT, Row #5:  26  26  26  26  26  26  26  26 
%     DQT, Row #6:  26  26  26  26  26  26  26  26 
%     DQT, Row #7:  26  26  26  26  26  26  26  26 
%     Approx quality factor = 88.24 (scaling=23.52 variance=21.42)
%
% The Exif image data matches the reported camera at the end of the
% JPEGsnoop data.

% imageOrigin4.jpg

%     [Make] = "Minolta Co., Ltd."
%     [Model] = "DiMAGE S304"
% Luminance Tables
%     DQT, Row #0:   4   3  11  14  17  15   8  14 
%     DQT, Row #1:   2   6  17  16   4   6  24  15 
%     DQT, Row #2:   4   3   7   3   4  22  10  18 
%     DQT, Row #3:   3   5   4   4  17   6  23  34 
%     DQT, Row #4:   4   6  16   5  22  29  29  34 
%     DQT, Row #5:  11  19   6  29  32  24  28  32 
%     DQT, Row #6:  16  10  31  26  22  20  28  28 
%     DQT, Row #7:  16  19  14  18  26  27  29  28 
%     Approx quality factor = 83.81 (scaling=32.39 variance=477.61)

% Chrominance Table:
%     DQT, Row #0:   4   5  28  28  28  28  28  28 
%     DQT, Row #1:   6  28  28  28   6  28  28  28 
%     DQT, Row #2:  13   5  28   7  18  28  28  28 
%     DQT, Row #3:   6  18  16  13  28  28  28  28 
%     DQT, Row #4:   7  28  28  28  28  28  28  28 
%     DQT, Row #5:  28  28  28  28  28  28  28  28 
%     DQT, Row #6:  28  28  28  28  28  28  28  28 
%     DQT, Row #7:  28  28  28  28  28  28  28  28 
%     Approx quality factor = 84.00 (scaling=32.00 variance=450.51)
% 

% In this image, the exif data reports a camera, but the quantization
% tables don't match a current model and it didn't report a software used
% either for compression. A different set of tables could indicate
% falsified information since most tables are embedded using the camera
% model itself or the editing software compression tables.

% imageOrigin5.jpg

%     [Make] = "SONY"
%     [Model] = "DSC-V1"

% Lumincance Table:
%     DQT, Row #0:   1   1   1   1   2   3   4   5 
%     DQT, Row #1:   1   1   1   2   2   5   5   4 
%     DQT, Row #2:   1   1   1   2   3   5   6   4 
%     DQT, Row #3:   1   1   2   2   4   7   6   5 
%     DQT, Row #4:   1   2   3   4   5   9   8   6 
%     DQT, Row #5:   2   3   4   5   6   8   9   7 
%     DQT, Row #6:   4   5   6   7   8  10  10   8 
%     DQT, Row #7:   6   7   8   8   9   8   8   8 
%     Approx quality factor = 96.06 (scaling=7.87 variance=0.69)

% Chrominance Table:
%     DQT, Row #0:   1   1   2   4   8   8   8   8 
%     DQT, Row #1:   1   2   2   5   8   8   8   8 
%     DQT, Row #2:   2   2   4   8   8   8   8   8 
%     DQT, Row #3:   4   5   8   8   8   8   8   8 
%     DQT, Row #4:   8   8   8   8   8   8   8   8 
%     DQT, Row #5:   8   8   8   8   8   8   8   8 
%     DQT, Row #6:   8   8   8   8   8   8   8   8 
%     DQT, Row #7:   8   8   8   8   8   8   8   8 
%     Approx quality factor = 96.02 (scaling=7.97 variance=0.33)
%
% For this image, the camera model is a match but it also shows a match to
% 8 other image editing softwares.

% imageOrigin6.jpg

% Exif camera identifying data doesn't exist within this file

% Luminance Table:
%     DQT, Row #0:   8   6   5   8  12  20  26  31 
%     DQT, Row #1:   6   6   7  10  13  29  30  28 
%     DQT, Row #2:   7   7   8  12  20  29  35  28 
%     DQT, Row #3:   7   9  11  15  26  44  40  31 
%     DQT, Row #4:   9  11  19  28  34  55  52  39 
%     DQT, Row #5:  12  18  28  32  41  52  57  46 
%     DQT, Row #6:  25  32  39  44  52  61  60  51 
%     DQT, Row #7:  36  46  48  49  56  50  52  50 
%     Approx quality factor = 74.75 (scaling=50.51 variance=0.81)

% Chrominance Table:
%     DQT, Row #0:   9   9  12  24  50  50  50  50 
%     DQT, Row #1:   9  11  13  33  50  50  50  50 
%     DQT, Row #2:  12  13  28  50  50  50  50  50 
%     DQT, Row #3:  24  33  50  50  50  50  50  50 
%     DQT, Row #4:  50  50  50  50  50  50  50  50 
%     DQT, Row #5:  50  50  50  50  50  50  50  50 
%     DQT, Row #6:  50  50  50  50  50  50  50  50 
%     DQT, Row #7:  50  50  50  50  50  50  50  50 
%     Approx quality factor = 74.74 (scaling=50.52 variance=0.19)

%%
% There's no camera signature but the tables match various image editing
% softwares and a single camera. Most likely, this image has been edited
% usign one of the softwares. The origin wasn't falsified.

%%
% A method of getting past JPEGsnoop and falsifying image origin would be
% to edit the Exif headers on a JPEG for a diferent camera model and also
% changing the listed quantization tables to match the new camera.

%% Part 2
clear all;clc;close all;

k1 = FQ("blockArtifacts1.tif");

%%
% k1 = 0.4062, which means blockArtifacts1.tif is compressed

%%

k2 = FQ("blockArtifacts2.tif");

% k2 = 0.4284, which means image was compressed

%%

k3 = FQ("blockArtifacts3.tif");

% k3 = 0.3913, which means image was compressed

%% 
% If the image has not been compressed, you expect both histograms to be
% the same, since the sums calculated earlier will be 0. If the image has
% been compressed, due to quantization, these sums will no longer be 0
% (sumes between ABCD and EFGH), therefore resulting to different
% histograms.

%% FQ function

function K = FQ(I)

    % read the input image
    I = imread(I);

    % get rows and columns of original image 
    [rowsI, colsI] = size(I); 

    rowsZP = rowsI/8;
    colsZP = colsI/8;

    % initialize Z prime and Z prime prime

    ZP = zeros(rowsZP, colsZP);
    ZPP = zeros(rowsZP, colsZP);

    % run for loop for each 8x8 block individually
    for i=0:rowsZP-1

        % used to go to next block
        inext = i+1;

        for j=0:colsZP-1

            % this will guarantee moving to the next block
            jnext = j+1;

            % find the following values


            A = I(8*(i)+4, 8*(j)+4);
            B = I(8*(i)+5, 8*(j)+4);
            C = I(8*(i)+4, 8*(j)+5);
            D = I(8*(i)+5, 8*(j)+5);

            ZP(i+1,j+1)=abs(A-B-C+D);


            if jnext~=64 && inext~=48

                E = I(8*inext, 8*jnext);
                F = I(8*inext,8*jnext+1);
                G = I(8*inext+1, 8*jnext);
                H = I(8*inext+1, 8*jnext+1);

                ZPP(i+1,j+1) = abs(E-F-H+G);

            end

        end
    end

    hI = hist(ZP);

    hII = hist(ZPP);

    hI = hist(ZP)./sum(hI,'all');

    hII = hist(ZPP)./sum(hII,'all');
    
    figure;
    subplot(1,2,1);
    histogram(hI);
    title('H1');

    subplot(1,2,2);
    histogram(hII);
    title('H2');

    K = sum(abs(hI-hII), 'all');

end